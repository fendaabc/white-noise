<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬å››é˜¶æ®µæ•°æ®æŒä¹…åŒ–éªŒè¯æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .test-container { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-title { color: #333; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; margin-bottom: 20px; }
        .test-result { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #45a049; }
        .config-viewer { background: #f8f9fa; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>ğŸ”„ ç¬¬å››é˜¶æ®µï¼šæ•°æ®æŒä¹…åŒ–éªŒè¯æµ‹è¯•</h1>
    
    <div class="test-container">
        <h2 class="test-title">1. ConfigManageråŸºç¡€åŠŸèƒ½æµ‹è¯•</h2>
        <div id="config-manager-results"></div>
        <button onclick="testConfigManager()">æµ‹è¯•ConfigManager</button>
    </div>

    <div class="test-container">
        <h2 class="test-title">2. é…ç½®å­˜å‚¨å’Œè¿ç§»æµ‹è¯•</h2>
        <div id="storage-results"></div>
        <button onclick="testStorage()">æµ‹è¯•å­˜å‚¨åŠŸèƒ½</button>
        <button onclick="testMigration()">æµ‹è¯•ç‰ˆæœ¬è¿ç§»</button>
    </div>

    <div class="test-container">
        <h2 class="test-title">3. é”™è¯¯å¤„ç†å’Œé›†æˆæµ‹è¯•</h2>
        <div id="integration-results"></div>
        <button onclick="testErrorHandling()">æµ‹è¯•é”™è¯¯å¤„ç†</button>
        <button onclick="runFullTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
    </div>

    <div class="test-container">
        <h2 class="test-title">4. é…ç½®æŸ¥çœ‹å™¨</h2>
        <button onclick="loadCurrentConfig()">æŸ¥çœ‹å½“å‰é…ç½®</button>
        <div id="config-display" class="config-viewer">ç‚¹å‡»æŒ‰é’®æŸ¥çœ‹é…ç½®</div>
    </div>

    <script src="js/ConfigManager.js"></script>
    <script>
        let testConfigManager;

        function showResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            container.appendChild(div);
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        async function testConfigManager() {
            clearResults('config-manager-results');
            
            try {
                testConfigManager = new ConfigManager();
                showResult('config-manager-results', 'âœ… ConfigManager å®ä¾‹åˆ›å»ºæˆåŠŸ', 'success');

                const config = await testConfigManager.init();
                if (config && config.version) {
                    showResult('config-manager-results', `âœ… åˆå§‹åŒ–æˆåŠŸï¼Œç‰ˆæœ¬: ${config.version}`, 'success');
                } else {
                    showResult('config-manager-results', 'âŒ åˆå§‹åŒ–å¤±è´¥', 'error');
                }

                const requiredSections = ['settings', 'preferences', 'usage', 'cache'];
                let allPresent = true;
                requiredSections.forEach(section => {
                    if (!config[section]) {
                        showResult('config-manager-results', `âŒ ç¼ºå¤±: ${section}`, 'error');
                        allPresent = false;
                    }
                });

                if (allPresent) {
                    showResult('config-manager-results', 'âœ… é…ç½®ç»“æ„å®Œæ•´', 'success');
                }

                window.testConfigManager = testConfigManager;

            } catch (error) {
                showResult('config-manager-results', `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testStorage() {
            clearResults('storage-results');
            
            if (!testConfigManager) {
                showResult('storage-results', 'âš ï¸ è¯·å…ˆè¿è¡ŒConfigManageræµ‹è¯•', 'warning');
                return;
            }

            try {
                // æµ‹è¯•è®¾ç½®æ›´æ–°
                const testSettings = {
                    volume: 85,
                    currentMode: 'campus',
                    customSounds: { test: { type: 'local' } }
                };

                const saveResult = testConfigManager.updateSettings(testSettings);
                if (saveResult) {
                    showResult('storage-results', 'âœ… è®¾ç½®æ›´æ–°æˆåŠŸ', 'success');
                }

                // æµ‹è¯•è¯»å–
                const settings = testConfigManager.getSettings();
                if (settings && settings.volume === 85) {
                    showResult('storage-results', 'âœ… è®¾ç½®è¯»å–æ­£ç¡®', 'success');
                }

                // æµ‹è¯•ä½¿ç”¨ç»Ÿè®¡
                testConfigManager.incrementSessionCount();
                testConfigManager.addPlayTime(30);
                testConfigManager.updateRecentSounds('waves');
                
                const usage = testConfigManager.getUsageStats();
                if (usage.totalSessions > 0) {
                    showResult('storage-results', 'âœ… ä½¿ç”¨ç»Ÿè®¡åŠŸèƒ½æ­£å¸¸', 'success');
                }

            } catch (error) {
                showResult('storage-results', `âŒ å­˜å‚¨æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testMigration() {
            clearResults('storage-results');
            
            try {
                // æ¨¡æ‹Ÿæ—§ç‰ˆæœ¬é…ç½®
                const oldConfig = {
                    volume: 60,
                    playingSounds: ['waves'],
                    currentMode: 'normal'
                };

                const migrationRule = testConfigManager.migrationRules.get('1.0.0->2.0.0');
                if (migrationRule) {
                    const migratedConfig = migrationRule(oldConfig);
                    showResult('storage-results', 'âœ… è¿ç§»è§„åˆ™æ‰§è¡ŒæˆåŠŸ', 'success');
                    
                    if (migratedConfig.settings.volume === 60) {
                        showResult('storage-results', 'âœ… æ•°æ®è¿ç§»æ­£ç¡®', 'success');
                    }
                }

                // æµ‹è¯•å¤‡ä»½
                testConfigManager.backupConfig(oldConfig, '1.0.0');
                showResult('storage-results', 'âœ… é…ç½®å¤‡ä»½åŠŸèƒ½æ­£å¸¸', 'success');

            } catch (error) {
                showResult('storage-results', `âŒ è¿ç§»æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testErrorHandling() {
            clearResults('integration-results');
            
            try {
                // æµ‹è¯•æ— æ•ˆé…ç½®
                const invalidConfigs = [null, undefined, 'invalid', {}];
                let validationPassed = true;
                
                invalidConfigs.forEach((config, index) => {
                    if (testConfigManager && testConfigManager.validateConfig(config)) {
                        showResult('integration-results', `âŒ æ— æ•ˆé…ç½®${index + 1}é€šè¿‡éªŒè¯`, 'error');
                        validationPassed = false;
                    }
                });

                if (validationPassed) {
                    showResult('integration-results', 'âœ… é…ç½®éªŒè¯åŠŸèƒ½æ­£å¸¸', 'success');
                }

                // æµ‹è¯•å­˜å‚¨ä½¿ç”¨æƒ…å†µ
                const usage = testConfigManager.getStorageUsage();
                if (usage) {
                    showResult('integration-results', `ğŸ“Š å­˜å‚¨ä½¿ç”¨: ${usage.totalMB}MB`, 'info');
                }

                // æµ‹è¯•æ¸…ç†åŠŸèƒ½
                testConfigManager.cleanupOldData();
                showResult('integration-results', 'âœ… æ•°æ®æ¸…ç†åŠŸèƒ½æ­£å¸¸', 'success');

            } catch (error) {
                showResult('integration-results', `âŒ é”™è¯¯å¤„ç†æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function runFullTest() {
            clearResults('integration-results');
            showResult('integration-results', 'ğŸš€ å¼€å§‹å®Œæ•´æµ‹è¯•...', 'info');
            
            try {
                await testConfigManager();
                testStorage();
                await testMigration();
                testErrorHandling();
                
                showResult('integration-results', 'ğŸ‰ ç¬¬å››é˜¶æ®µæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼', 'success');
            } catch (error) {
                showResult('integration-results', `âŒ å®Œæ•´æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function loadCurrentConfig() {
            if (!testConfigManager) {
                document.getElementById('config-display').textContent = 'è¯·å…ˆè¿è¡ŒConfigManageræµ‹è¯•';
                return;
            }

            try {
                const config = testConfigManager.loadConfig();
                document.getElementById('config-display').textContent = JSON.stringify(config, null, 2);
            } catch (error) {
                document.getElementById('config-display').textContent = `é”™è¯¯: ${error.message}`;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºæœ¬æµ‹è¯•
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(testConfigManager, 100);
        });
    </script>
</body>
</html>